<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0-beta1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-0evHe/X+R7YkIZDRvuzKMRqM+OrBnVFBL6DOitfPri4tjfHxaWutUpFmBp4vmVor" crossorigin="anonymous">
    
    <script src="https://code.highcharts.com/stock/highstock.js"></script>
    <script src="https://code.highcharts.com/stock/modules/data.js"></script>
    <script src="https://code.highcharts.com/modules/accessibility.js"></script>
    
    <title>HISTORIAL</title>

</head>
<body>
    
    
    <div class="mx-auto">
        <nav class="navbar navbar-expand-lg navbar-dark bg-dark text-white">
            <div class="container-fluid">
            <a class="navbar-brand" href="/">HOME</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse justify-content-end" id="navbarNav">
                <ul class="navbar-nav">
                <li class="nav-item">
                    <a class="nav-link active" aria-current="page" href="/tiemporeal">Tiempo real</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="/historial">Historial</a>
                </li>
                </ul>
            </div>
            </div>
        </nav>
    </div>

    <div  class="card card-body bg-dark text-white p-1 mx-auto m-5" style="width: 33rem;">
        <label class="h3 text-center m-4">Seleccione el sensor de su interes</label>
                <select class="form-control mx-auto text-center" style="width: 15rem;">
                    <option value="temperatura">Presion atmosferica (hPa)</option>
                    <option value="Presion">Temperatura (°C)</option>
                    <option value="humedad">Humedad</option>
                    <option value="altitud">Altitud</option>
                </select>
                    
        <button id="btnSenInd"  class="btn btn-primary mx-auto m-3" style="width: 25rem;">DESCARGAR HISTORIAL DE SENSOR INDIVIDUAL</button>
        <button id="btnTotal" class="btn btn-primary mx-auto m-3" style="width: 25rem;">DESCARGAR HISTORIAL DE TODOS LOS SENSORES</button>
    </div>

    <h2 class="text-center">ESP Weather Station</h2>
    <button id="btnHist" class="btn btn-primary mx-auto m-3" style="width: 7rem;">Ver historial</button>
    
    <div class="mx-auto row" style="background:rgb(204, 26, 26);">
        
        <div id="chart-temperature" class="m-2 col-5" ></div>
        <div id="chart-humidity" class="m-2 col-5" ></div>
        <div id="chart-pressure" class="m-2 col-5" ></div>
        <div id="chart-altitude" class="m-2 col-5" ></div>

    </div>
 
</body> 

<script>
    var listSensores =["temperatura","presion","humedad","altitud"];
//---------GRAFICAS--------------------------------------------
    const desInd = document.getElementById('btnSenInd');
    const desTotal = document.getElementById('btnTotal');
    const verHist = document.getElementById('btnHist');
    
    
/*
    datosjson = {
        "mediciones" : [{"temperatura":26.50,"humedad":33.69,"presion":1010.22,"altitud":25.23,"fecha":"2022-06-21T08:22:23"},
                        {"temperatura":24.50,"humedad":30.69,"presion":1011.22,"altitud":22.23,"fecha":"2022-06-22T05:22:23"},
                        {"temperatura":23.50,"humedad":35.69,"presion":1015.22,"altitud":27.23,"fecha":"2022-06-25T10:22:23"},
                        {"temperatura":29.50,"humedad":38.69,"presion":1020.22,"altitud":20.23,"fecha":"2022-06-26T05:22:23"},
                        {"temperatura":31.50,"humedad":33.69,"presion":1018.22,"altitud":21.23,"fecha":"2022-06-26T12:15:23"}]
    }
*/
    const charT = Highcharts.stockChart('chart-temperature', {
        chart: {
            height: 400
        },

        title: {
            text: 'Temperatura'
        },

        subtitle: {
            text: 'Seleccione el rango a convenir'
        },
        rangeSelector: {

            buttons: [
                {
                type: 'week',
                count: 1,
                text: '1s'
            }, {
                type: 'month',
                count: 1,
                text: '1m'
            }, {
                type: 'month',
                count: 6,
                text: '6m'
            }, {
                type: 'year',
                count: 1,
                text: '1y'
            }, {
                type: 'all',
                text: 'All'
            }],
            selected: 5
            },

        series: [{
            name: 'Medicion: ',
            data: [],
            type: 'area',
            threshold: null,
            tooltip: {
                valueDecimals: 2,
                valueSuffix: '°C'
            }
            
        }],
        
        
        
    });

    
    const charH = Highcharts.stockChart('chart-humidity', {
        chart: {
            height: 400
        },

        title: {
            text: 'Humedad'
        },
        
        subtitle: {
            text: 'Seleccione el rango a convenir'
        },

        rangeSelector: {

            buttons: [
                {
                type: 'week',
                count: 1,
                text: '1s'
            }, {
                type: 'month',
                count: 1,
                text: '1m'
            }, {
                type: 'month',
                count: 6,
                text: '6m'
            }, {
                type: 'year',
                count: 1,
                text: '1y'
            }, {
                type: 'all',
                text: 'All'
            }],
            selected: 5
        },

        series: [{
            name: 'Medicion: ',
            data: [],
            type: 'area',
            threshold: null,
            tooltip: {
                valueDecimals: 2,
                valueSuffix: '%'
            }
        }],
        
        
        
    });


    const charP = Highcharts.stockChart('chart-pressure', {
        chart: {
            height: 400
        },

        title: {
            text: 'Presion'
        },

        subtitle: {
            text: 'Seleccione el rango a convenir'
        },

        rangeSelector: {

            buttons: [
                {
                type: 'week',
                count: 1,
                text: '1s'
            }, {
                type: 'month',
                count: 1,
                text: '1m'
            }, {
                type: 'month',
                count: 6,
                text: '6m'
            }, {
                type: 'year',
                count: 1,
                text: '1y'
            }, {
                type: 'all',
                text: 'All'
            }],
            selected: 5
        },

        series: [{
            name: 'Medicion: ',
            data: [],
            type: 'area',
            threshold: null,
            tooltip: {
                valueDecimals: 2,
                valueSuffix: 'hPa'
            },
            showInLegend: false
        }],
        
        
        
    });


    const charA = Highcharts.stockChart('chart-altitude', {
        chart: {
            height: 400
        },

        title: {
            text: 'Altitud'
        },

        subtitle: {
            text: 'Seleccione el rango a convenir'
        },
        
        rangeSelector: {

            buttons: [
                {
                type: 'week',
                count: 1,
                text: '1s'
            }, {
                type: 'month',
                count: 1,
                text: '1m'
            }, {
                type: 'month',
                count: 6,
                text: '6m'
            }, {
                type: 'year',
                count: 1,
                text: '1y'
            }, {
                type: 'all',
                text: 'All'
            }],
            selected: 5
        },

        series: [{
            name: 'Medicion: ',
            data: [],
            type: 'area',
            threshold: null,
            tooltip: {
                valueDecimals: 2,
                valueSuffix: 'm'
            },
            
        }],
        
        
        
    });

    
    function download(filename, text) {
        var element = document.createElement('a');
        element.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(text));
        element.setAttribute('download', filename);

        element.style.display = 'none';
        document.body.appendChild(element);

        element.click();

        document.body.removeChild(element);
    }

    function btDescSen(){
        const sensor = document.querySelector('.list-sensor').value;
        var objGen = {};
        objGen[sensor] = [];
        var objInd = {};
        fetch('historial/datos/')
        .then(response => {
            if(response.ok){
                response.json().then(datosjson =>{
                    datosjson.mediciones.forEach(sen => {
                        objInd.medicion = sen[sensor];
                        objInd.fecha = e.fecha;
                        objGen[sensor].push(objInd)
                    });

                    download(sensor+'.json',JSON.stringify(objGen));
                });

            }}).catch(() =>{
                        alert('Sin respuesta')
                    });
        
    };

    desInd.addEventListener('click',btDescSen,false);

    function btDescTotal(){
        
        fetch('historial/datos/')
        .then(response => {
            if(response.ok){
                response.json().then(datosjson =>{
                    download('Datos_Total.json',JSON.stringify(objGen));
                });

            }}).catch(() =>{
                        alert('Sin respuesta')
                    });
        
    };

    desTotal.addEventListener('click',btDescTotal,false);

    function extData(sensor,data){
        list1 =[];
        list2 =[];

        data.mediciones.forEach(i => {
            list2.push(Math.round(new Date(i.fecha).getTime()));
            //console.log(Math.round(new Date(i.fecha).getTime()/1000.0));
            list2.push(i[sensor]);
            list1.push(list2);
            list2 = [];
        });

        return list1;
    }

    function btHist(){
        
        fetch('historial/datos/')
        .then(response => {
            if(response.ok){
                response.json().then(datosjson =>{
                    data = extData('temperatura',datosjson);
                    data.forEach(plot => {
                        console.log(charT);
                        charT.series[0].addPoint(plot, true, false, true);
                    }); 

                    data = extData('humedad',datosjson); 
                    data.forEach(plot => {
                        charH.series[0].addPoint(plot, true, false, true);
                    });

                    data = extData('presion',datosjson); 
                    data.forEach(plot => {
                        charP.series[0].addPoint(plot, true, false, true);
                    });

                    data = extData('altitud',datosjson); 
                    data.forEach(plot => {
                        charA.series[0].addPoint(plot, true, false, true);
                    });
                    
                });

            }}).catch(() =>{
                        alert('Sin respuesta')
                    });
        
    };

    verHist.addEventListener('click',btHist,false);

</script>

</html> 